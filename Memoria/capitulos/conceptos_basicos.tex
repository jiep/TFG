\chapter{Conceptos básicos} \label{chp:conceptos_basicos}

En este capítulo veremos dos conceptos centrales de esta memoria: ranking y rating, y veremos varios métodos para crear rankings.\\

Para entender estos conceptos intuitivamente veamos un ejemplo:

\begin{ejemplo}
Si consideramos los siguientes jugadores de la NBA: Kareem Abdul-Jabbar, Karl Malone, Michael Jordan, Kobe Bryant y Wilt Chamberlain, y consideramos los puntos y rebotes\footnote{Datos extraídos de \url{http://stats.nba.com/leaders/alltime}} anotados por cada uno de estos jugadores a lo largo de su carrera en temporada regular, obtenemos la siguiente tabla:

\begin{table}[h]
\centering
\caption[Puntos y rebotes de los máximos anotadores de la NBA]{Puntos y rebotes de los máximos anotadores de la NBA en temporada regular}
\label{tbl:puntos_rebotes}
\begin{tabular}{@{}lcc@{}}
\cmidrule(l){2-3}
\multicolumn{1}{c}{}      & \multicolumn{2}{c}{En temporada regular} \\ \cmidrule(l){2-3} 
\multicolumn{1}{c}{}      & Puntos             & Rebotes             \\ \midrule
Kareem Adbul-Jabbar (KAJ) & 38387              & 17440               \\ \midrule
Karl Malone (KM)          & 36928              & 14968               \\ \midrule
Michael Jordan (MJ)       & 32292              & 6662                \\ \midrule
Kobe Bryant (KB)          & 32030              & 6672                \\ \midrule
Wilt Chamberlaint (WC)    & 31419              & 23924               \\ \bottomrule
\end{tabular}
\end{table}

Estas dos ordenaciones de los jugadores es lo que recibe el nombre de rating. De cada uno de estos ratings, se puede obtener un ranking que son las posiciones de cada jugador en cada rating. En el ejemplo,

\[
\begin{array}{ccc}
\text{Posición} & \text{Puntos} & \text{Rebotes}\\ 
\begin{array}{c}
\text{1}\\
\text{2}\\
\text{3}\\
\text{4}\\
\text{5}\\
\end{array} & \left(\begin{array}{c}
\text{KAJ}\\
\text{KM}\\
\text{MJ}\\
\text{KB}\\
\text{WC}\\
\end{array} \right) & \left(\begin{array}{c}
\text{WC}\\
\text{KAJ}\\
\text{KM}\\
\text{KB}\\
\text{MJ}\\
\end{array} \right)
\end{array}
\]

En general, los ratings producen distintos rankings. En el ejemplo, se puede ver como en el ranking de rebotes Wilt Chamberlain se encuentra en 1ª posición, mientras que en el de rebotes se encuentra en 5ª posición. Otros rankings ficticios para el ejemplo podrían ser

\[
\begin{array}{ccc}
\begin{array}{c}
\text{1}\\
\text{2}\\
\text{3}\\
\text{4}\\
\text{5}\\
\end{array} & \left(\begin{array}{c}
\text{MJ}\\
\text{KB}\\
\text{KM}\\
\text{KAJ}\\
\text{WC}\\
\end{array} \right) & \left(\begin{array}{c}
\text{KB}\\
\text{MJ}\\
\text{KM}\\
\text{WC}\\
\text{KAJ}\\
\end{array} \right)
\end{array}
\]

\end{ejemplo}

De forma intuitiva, podríamos decir que un rating es un criterio para ordenar una serie de elementos, y un ranking son todas los posibles ordenamientos de un un conjunto de elementos. De forma rigurosa, las definiciones anteriores quedan así:

\begin{defi} \label{def:ranking}
Dado un conjunto $\mathcal{N} = \{1,\dots,n\}$ que llamamos nodos, definimos el ranking $c$ como cualquier biyección $c : \mathcal{N} \to \mathcal{N}$.
\end{defi}

De acuerdo a esta definición, en el ejemplo, $\mathcal{N} = \{1,2,3,4,5\}$, donde $\text{KAJ}\equiv 1$, $\text{KM}\equiv 2$, $\text{MJ}\equiv 3$, $\text{KB}\equiv 4$, $\text{WC}\equiv 5$. Así, si consideramos el ranking de rebotes, entonces

\[ \begin{array}{rlll}
c: & \mathcal{N} & \to & \mathcal{N}\\
& 1 & \mapsto & 5\\
& 2 & \mapsto & 1\\
& 3 & \mapsto & 2\\
& 4 & \mapsto & 4\\
& 5 & \mapsto & 3\\
\end{array} \] 

que es claramente una biyección, por lo que $c$ es un ranking de acuerdo a la definición \ref{def:ranking}. De la misma forma se obtienen que los demás rankings también cumplen la definición.\\

Además, escribiremos $i \prec_c j$ cuando el nodo $i \in \mathcal{N}$ aparezca antes que el nodo $j \in \mathcal{N}$ en el ranking $c$.

En el ejemplo, el nodo $5 \prec_c 3$ ya que el nodo $5$, WC aparece más alto que el nodo $3$, MJ.

\begin{defi}
Dado un conjunto $\mathcal{N} = \{1,\dots, n\}$ de nodos, decimos que es un rating si a cada $i \in \mathcal{N}$ se le asigna un valor real. 
\end{defi}

Notar que un rating cuando se ordena (ascendente o descendentemente), crea un ranking.\\

En el ejemplo anterior, la cantidad de puntos y rebotes a lo largo de la carrera en temporada regular en la NBA son ratings, y dados éstos obtenemos un ranking. En estos dos casos, hemos ordenado descendentemente el rating, pero también podría ordenarse de forma ascendente como en el caso de número de pérdidas de balón por partido a lo largo de la temporada regular. 

\section{Métodos para obtener ratings (y rankings)}
\todo[backgroundcolor=red, inline]{Añadir pequeña introducción}
\subsection{Método de Massey}
El método de Massey fue creado por Kenneth Massey en 1997 con la intención de obtener rankings de los equipos universitarios de EEUU. Este método usa la teoría de mínimos cuadrados. La idea fundamental de este método se basa en la siguiente ecuación idealizada:

\begin{equation}
r_i - r_j = y_k
\end{equation} 

donde $y_k$ es el margen de victoria para el partido $k$, y $r_i$ y $r_j$ son los ratings de los equipos $i$ y $j$, respectivamente. En otras palabras, la diferencia de los ratings $r_i$ y $r_j$ de dos equipos predice idealmente el margen de victoria en un enfrentamiento entre estos dos equipos. \\

El objetivo es asociar un rating a cada equipo en una liga con $n$ equipos, donde $m$ es el total de partidos disputados hasta la fecha. No conocemos los ratings $r_i$, pero sí conocemos quién jugó con quién y el margen de victoria. De esta manera, podemos formar para cada partido $k$ un sistema lineal con $m$ ecuaciones y $n$ incógnitas:

\[\mathbf{X r } = \mathbf{y}\]

Los coeficientes de cada fila de la matriz $\mathbf{X}$ son casi todos nulos, excepto en la posición $i$ que tiene un $1$, y en la posición $j$ con un $-1$, para indicar que el equipo $i$ gana al equipo $j$ en un partido. Normalmente, $m \gg n$ que hace que el sistema sea incompatible y no tenga solución. Se puede obtener una solución aplicando las ecuaciones normales de los mínimos cuadrados, quedando el sistema $\mathbf{X^T X r} = \mathbf{X^T y}$. \\

Massey descubrió que debido a la estructura de $\mathbf{X}$ era ventajoso la utilización de la matriz $\mathbf{M} = \mathbf{X^T X}$. De hecho, esta matriz no necesita ser calculada. Se puede obtener fácilmente usando el hecho de que los elementos de la diagonal $\mathbf{M}_{ii}$ es el total de partidos jugados por el $i$ contra el equipo $j$, y los elementos $\mathbf{M}_{ij}$ con $(i \neq j)$ es la negación del número de partidos jugados por el equipo $i$ contra el equipo $j$. El elemento i-ésimo de parte derecha de la ecuación se puede calcular es la suma de las diferencias de puntos para cada partidos disputado por el equipo $i$, y así definimos $\mathbf{p} = \mathbf{X^T y}$.\\
Usando estas notaciones el sistema se transforma en el siguiente sistema:

\[ \mathbf{M r} = \mathbf{p} \]

\paragraph*{Propiedades de la matriz $\mathbf{M}$}

\begin{enumerate}
\item La matriz $\mathbf{M}$ es una matriz cuadrada de orden $n$.
\item $\mathbf{M}$ es una matriz diagonalmente dominante.
\item Sus filas suman $0$. Como consecuencia, sus columnas son linealmente dependientes. Esto hace que el sistema  $\mathbf{M r} = \mathbf{p}$ no tenga solución única cuando el $\rang(\mathbf{M}) < n$. El problema se puede solventar añadiendo una fila entera de $1$ y en la posición correspondiente de $\mathbf{p}$ añadir un $0$. Con la nueva fila, el sistema queda 
\begin{equation}
\overline{\mathbf{M}} \mathbf{r} = \overline{\mathbf{p}} \label{eq:massey_general}
\end{equation}
\end{enumerate}

\begin{ejemplo}\label{ej:massey}
Si consideramos una liga formada por los siguientes equipos de la NBA: Denver Nuggets (DEN), Los Ángeles Lakers (LAL), San Antonio Spurs (SAS), Chicago Bulls (CHI) y New York Knicks (NYK), y los partidos disputados entre estos equipos (Tabla \ref*{tbl:massey})

\begin{table}[h]
\centering
\caption{Partidos disputados por los equipos del Ejemplo \ref{ej:massey}}
\label{tbl:massey}
\begin{tabular}{ccccccc}
\cline{2-7}
    & DEN     & LAL     & SAS     & CHI     & NYK     & \begin{tabular}[c]{@{}c@{}}Diferencia\\ de puntos\end{tabular} \\ \hline
DEN & ---     & 137-115 & 103-108 & 89-117  & 90-117  & \textcolor{red}{-38}                                        \\ \hline
LAL & 115-137 & ---     & 113-100 & 100-102 & 103-110 & \textcolor{red}{-18}                                         \\ \hline
SAS & 108-103 & 100-113 & ---     & 104-96  & 110-89  & \textcolor{green}{21}                                                            \\ \hline
CHI & 117-89  & 102-100 & 96-104  & ---     & 89-100  & \textcolor{green}{11}                                         \\ \hline
NYK & 117-90  & 110-103 & 89-110  & 100-89  & ---     & \textcolor{green}{24}                                        \\ \hline
\end{tabular}
\end{table}

Necesitamos la matriz $\mathbf{\overline{M}}$ de Massey y el vector $\mathbf{p}$ de diferencia de puntos para formar el sistema $\mathbf{\overline{M} r} = \mathbf{p}$.\\

Formamos la matriz $\mathbf{\overline{M}}$, poniendo en la diagonal el número de partidos jugados por cada equipo, en este caso $4$. En todos los demás elementos ponemos $-1$, excepto en la última fila que está formada por $1$ para conseguir que este sistema tenga una única solución. El vector $\mathbf{p}$ lo obtenemos directamente de la Tabla \ref{tbl:massey}, pero cambiando el último término por un $0$.\\
Así el sistema $\mathbf{\overline{M} r} = \mathbf{p}$ queda

\begin{equation*}
\left(\begin{array}{r r r r r}
4  & -1 & -1 & -1 & -1\\
-1 &  4 & -1 & -1 & -1\\
-1 & -1 &  4 & -1 & -1\\
-1 & -1 & -1 &  4 & -1\\
 1 &  1 &  1 &  1 &  1 
\end{array}\right)
\left(\begin{array}{c}
\mathbf{r}_{\text{DEN}}\\
\mathbf{r}_{\text{LAL}}\\
\mathbf{r}_{\text{SAS}}\\
\mathbf{r}_{\text{CHI}}\\
\mathbf{r}_{\text{NYK}}
\end{array}\right)
=
\left(\begin{array}{c}
-38\\
-18\\
21\\
11\\
0
\end{array}\right)
\end{equation*}

Resolviendo este sistema obtenemos los siguientes resultados (Tabla \ref{tbl:massey_resultados})

\begin{table}[h]
\centering
\caption{Resultados del Ejemplo \ref{ej:massey}}
\label{tbl:massey_resultados}
\begin{tabular}{@{}ccc@{}}
\cmidrule(l){2-3}
    & $\mathbf{r}$ & Ranking \\ \cmidrule(l){2-3} 
DEN & -7.6         & 5       \\ \midrule
LAL & -3.6         & 4       \\ \midrule
SAS & 4.2          & 2       \\ \midrule
CHI & 2.2          & 3       \\ \midrule
NYK & 4.8          & 1       \\ \bottomrule
\end{tabular}
\end{table}
\end{ejemplo}
\subsubsection{Método de Massey avanzado}

El método de Massey avanzado crea dos nuevos vectores respecto al método anterior: el rating ofensivo $\mathbf{o}$ y el rating defensivo $\mathbf{d}$, con $\mathbf{r} = \mathbf{o} + \mathbf{d}$. Este método descompone $\mathbf{p}$ en otros dos vectores: $ \mathbf{p} = \mathbf{f} - \mathbf{a}$, donde $\mathbf{f}$ es el número total de puntos marcados por cada equipo, y $\mathbf{a}$ es el número total de puntos marcados contra cada equipo durante la temporada. También se descompone la matriz $\mathbf{M}$ como $\mathbf{M} = \mathbf{T} - \mathbf{P}$, donde $\mathbf{T}$ es una matriz diagonal que contiene el número total de partidos disputados por cada equipo, y $\mathbf{P}$ una matriz sin elementos en la diagonal que contiene el número de parejas de partidos entre los equipos a lo largo de la temporada. Haciendo las sustituciones al sistema $\mathbf{M r } = \mathbf{p}$, el sistema se convierte en

\begin{equation}
\mathbf{T o} - \mathbf{P o} + \mathbf{T d} - \mathbf{P d} = \mathbf{f} - \mathbf{a}
\end{equation}

que puede ser descompuesta en dos ecuaciones

\begin{eqnarray}
\mathbf{T o} - \mathbf{P d} = \mathbf{f}\\ \label{eq:massey_f}
\mathbf{P o} - \mathbf{T d} = \mathbf{a} \label{eq:massey}
\end{eqnarray} 

Sabiendo que $\mathbf{r} = \mathbf{o} + \mathbf{d}$, despejando $\mathbf{o}$ y sustituyendo en la ecuación \ref{eq:massey_f} obtenemos

\begin{equation}
(\mathbf{T} + \mathbf{P})\mathbf{d} = \mathbf{T r} - \mathbf{f} \label{eq:massey_d}
\end{equation}

Esta última ecuación nos permite calcular el vector $\mathbf{d}$ resolviendo el sistema. Notar que $\mathbf{r}$ ya ha sido calculado de la ecuación \ref{eq:massey_general}.

\begin{ejemplo}\label{ej:massey_avanzado}
Volvemos a considerar los datos del Ejemplo \ref{ej:massey}. En este caso necesitamos la suma de los puntos a favor y en contra para cada equipo (Tabla \ref{tbl:massey_avanzado})

\begin{table}[h]
\centering
\caption{Datos del Ejemplo \ref{ej:massey_avanzado}}
\label{tbl:massey_avanzado}
\begin{tabular}{@{}ccc@{}}
\cmidrule(l){2-3}
    & \begin{tabular}[c]{@{}c@{}}Puntos\\ a favor\end{tabular} & \begin{tabular}[c]{@{}c@{}}Puntos\\ en contra\end{tabular} \\ \midrule
DEN & 419                                                      & 459                                                        \\
LAL & 431                                                      & 449                                                        \\
SAS & 422                                                      & 401                                                        \\
CHI & 404                                                      & 393                                                        \\
NYK & 416                                                      & 392                                                        \\ \bottomrule
\end{tabular}
\end{table}

Para obtener los vectores $\mathbf{d}$ y $\mathbf{o}$ necesitamos resolver el sistema 

\begin{equation*}
(\mathbf{T} + \mathbf{P}) \mathbf{d} = \mathbf{T} \mathbf{r} - \mathbf{f}
\end{equation*}

La matriz diagonal $\mathbf{T}$ la formamos con el número de partidos jugados por el equipo, en este caso, $4$. La matriz $\mathbf{P}$ la formamos con el número de partidos jugados entre el equipo $i$ y $j$, en este caso, $1$. Los elementos de la diagonal principal todos son $0$. Los vectores $\mathbf{f}$ y $\mathbf{a}$ son directamente la columna ``Puntos a favor'' y ``Puntos en contra'' de la Tabla \ref{tbl:massey_avanzado}. El vector $\mathbf{r}$ ya ha sido calculado en el Ejemplo \ref{ej:massey}. Resolviendo el sistema lineal obtenemos $d$, y usando la relación $\mathbf{r} = \mathbf{o} + \mathbf{d}$, podemos calcular el vector $o$. La Tabla \ref{tbl:massey_avanzado_resultados} muestra los resultados del cálculo.

\begin{table}[h]
\centering
\caption{Resultados del Ejemplo \ref{ej:massey_avanzado}}
\label{tbl:massey_avanzado_resultados}
\begin{tabular}{@{}ccccccc@{}}
\cmidrule(l){2-7}
    & $\mathbf{o}$ & Ranking & $\mathbf{d}$ & Ranking & $\mathbf{r}$ & Ranking \\ \midrule
DEN & 55.03        & 2       & -62.63       & 5       & -7.6         & 5       \\
LAL & 57.03        & 1       & -61.30       & 4       & -3.6         & 4       \\
SAS & 52.10        & 3       & -47.90       & 3       & 4.2          & 2       \\
CHI & 46.76        & 4       & -44.56       & 1       & 2.2          & 3       \\
NYK & 49.90        & 5       & 45.1         & 2       & 4.8          & 1       \\ \bottomrule
\end{tabular}
\end{table}


\end{ejemplo}

\paragraph*{Resumen y algoritmo de cómputo}

La siguiente tabla muestra todos los elementos y su descripción dentro del método que acabamos de describir:

\begin{longtable}{c c p{5cm} p{6cm}}
%{>{\centering\arraybackslash}p{2cm} >{\centering\arraybackslash}p{1.5cm} >{\centering\arraybackslash}p{5cm} >{\centering\arraybackslash}p{6cm}}
\caption{Resumen del método de Massey}\\
%\renewcommand{\arraystretch}{1.5}
\toprule
Variable & Tipo & Descripción & Elemento i-ésimo\\
\hline
\endfirsthead

$n$ & $\N$ & Número de equipos en la liga. Orden de las matrices $\mathbf{T}$,$\mathbf{T}$ y $\mathbf{P}$. & ---\\
\hline
$m$ & $\N$ & Número de partidos jugados & ---\\
\hline
$\mathbf{X}$ & $M_{m\times n}$\footnote{Matrices de tamaño $m \times n$} & Matriz de partidos por equipo & $\mathbf{X}_{ki} = \begin{cases}
1 & \text{si } i \text{ ganó en el partido } k \\
 -1 & \text{si } i \text{ perdió} \\ 
0 & \text{en otro caso}
\end{cases}$ \\
\hline
$\mathbf{T}$ & $M_{n\times n}$ & Matriz diagonal que contiene el número total de partidos disputados & $\mathbf{T}_{ii} = $ número total de partidos disputados por el equipo $i$ \\
\hline
$\mathbf{P}$ & $M_{n\times n}$ & Matriz sin elementos en la diagonal que  contiene información de los partidos & $\mathbf{P}_{ij} = $ número de partidos entre $i$ y $j$ \\
\hline
$\mathbf{M}$ & $M_{n\times n}$ & Matriz simétrica llamada matriz de Massey & $\mathbf{M} = \mathbf{T}-\mathbf{P}$ \\
\hline 
$\overline{\mathbf{M}}$ & $M_{n \times n}$ & Matriz ajustada de Massey que se crea  remplazando una fila de $\mathbf{M}$ por un vector de unos & --- \\
\hline 
$\mathbf{f}$ & $M_{n\times 1}$ & Vector de puntos marcados & $\mathbf{f}_i = $ número de puntos  marcados por $i$ durante la temporada \\
\hline 
$\mathbf{a}$ & $M_{n\times 1}$ & Vector de puntos encajados & $\mathbf{f}_i = $ número de puntos encajados por $i$ durante la temporada \\
\hline 
$\mathbf{p}$ & $M_{n\times 1}$ & Vector de diferencias de puntos & $\mathbf{p}_i = f_i - a_i$ diferencia de puntos acumulados por $i$ durante la temporada \\
\hline 
$\overline{\mathbf{T}}$ & $M_{n\times 1}$ & Vector de diferencias de puntos ajustado creado poniendo un  elemento de $\mathbf{p}$ con $0$ & ---\\
\hline
$\mathbf{r}$ & $M_{n\times 1}$ & Vector de rating producido por 
\ref{eq:massey_general} & ---\\
\hline
$\mathbf{o}$ & $M_{n\times 1}$ & Vector de ranking ofensivo producido
por \ref{eq:massey_general} & ---\\
\hline 
$\mathbf{d}$ & $M_{n\times 1}$ & Vector de ranking defensivo producido por \ref{eq:massey_general} & ---\\

\bottomrule
\end{longtable}

El algoritmo que permite calcular este método es el siguiente:

\begin{enumerate}
\item Resolver el sistema \ref{eq:massey_general}.
\item Resolver el sistema \ref{eq:massey_d}.
\item Calcular el vector $\mathbf{o} = \mathbf{r} - \mathbf{d}$.
\end{enumerate}

\subsection{Método de Colley}

El método de Colley fue creado por el Dr. Wesley Colley en 2001. Su método está basado una idea muy sencilla: el rating del equipo $i$ será el número total de victorias $w_i$ dividido entre el número total de partidos disputados $t_i$, es decir, 

\begin{equation}
r_i = \dfrac{w_i}{t_i}
\end{equation}

La ecuación anterior tiene algunos problemas como que al inicio de la temporada se obtiene un rating de $0/0$, no se tiene en cuenta el adversario al que se enfrenta un equipo, es decir, no se tiene en cuenta si un equipo ``fuerte'' se enfrenta a uno ``débil'' o viceversa. \\
Para solucionar estos problemas, Colley modifica la ecuación de tal forma que se soluciones los problemas anteriores. La ecuación queda de la siguiente manera:

\begin{equation}
r_i = \dfrac{1 + w_i}{2 + t_i} \label{eq:colley}
\end{equation}

De esta forma, al inicio de la temporada el rating del equipo $i$ es $r_i = 1/2$, que evita el $0/0$ de la primera ecuación. También tiene en cuenta la fuerza de los otros equipos, es decir, si un equipo se enfrenta a un equipo ``fuerte'' obtendrá mayor recompensa que otro que se haya enfrentado a un equipo ``débil''. Esto se consigue suponiendo que lo que gana un equipo lo pierde otro. De esta forma, y teniendo que cuenta que al inicio de la temporada el rating de todos los equipos es $1/2$, se obtiene que

\begin{align}
w_i & = \dfrac{w_i - l_i}{2} + \dfrac{w_i + l_i}{2} \\
&= \dfrac{w_i - l_i}{2} + \dfrac{t_i}{2} \\
&= \dfrac{w_i - l_i}{2} + \sum_{j=1}^{t_i} \dfrac{1}{2}
\end{align}  

donde $l_i$ son los partidos perdidos por el equipo $i$. La suma $\sum_{j=1}^{t_i} 1/2 $ es inicialmente igual a $\sum_{j \in O_i} r_j$ donde $O_i$ es el conjunto de oponentes del equipo $i$. A lo largo de la temporada el valor $\sum_{j=1}^{t_i} 1/2 $ no es igual a $\sum_{j \in O_i}$, pero puede ser aproximada por los rating acumulados de los oponentes de un equipo. Se obtiene que

\begin{equation}
w_i = \dfrac{w_i - l_i}{2} + \sum_{j \in O_i} r_j
\end{equation}  

Suponiendo igualdad y añadiendo la fórmula anterior en \ref{eq:colley} se obtiene

\begin{equation}
r_i = \dfrac{1+ (w_i - l_i)/2 + \sum_{j \in O_i} r_j }{2 + t_i}
\end{equation}

La ecuación anterior puede ser convertida en un sistema lineal $\mathbf{C r} = \mathbf{b}$, donde $\mathbf{r}$ es el vector incógnita de ratings, $\mathbf{b}$ es el vector definido como $b_i = 1 + \dfrac{1}{2}(w_i - l_i)$ y $\mathbf{C}$ es la matriz de Colley definida como

\begin{equation}\label{eq:colley_matriz}
\mathbf{C}_{ij} = \begin{cases}
2 + t_i & \text{si } i = j\\
-n_{ij} & \text{si } i \neq j
\end{cases}
\end{equation}

donde $n_{ij}$ es el número de veces que han jugado los equipos $i$ y $j$.

\begin{ejemplo} \label{ej:colley}
Volvemos a considerar los datos del Ejemplo \ref{ej:massey}. Para poder aplicar este método necesitamos el número de victorias y derrotas de cada equipo (Tabla \ref{tbl:colley})

\begin{table}[h]
\centering
\caption{Datos del Ejemplo \ref{ej:colley}}
\label{tbl:colley}
\begin{tabular}{@{}ccc@{}}
\cmidrule(l){2-3}
    & Victorias & Derrotas \\ \midrule
DEN & 1         & 3        \\
LAL & 1         & 3        \\
SAS & 3         & 1        \\
CHI & 2         & 2        \\
NYK & 3         & 1        \\ \bottomrule
\end{tabular}
\end{table}

Necesitamos calcular la matriz $\mathbf{C}$ que viene dada por la ecuación \ref{eq:colley_matriz} y el vector $\mathbf{b}$ que viene dado por

\begin{equation*}
b_i = 1 + \dfrac{1}{2}\left(w_i - l_i\right)
\end{equation*}

Así, el sistema $\mathbf{C r} = \mathbf{b}$ queda

\begin{equation*}
\left(\begin{array}{r r r r r}
 6 & -1 & -1 & -1 & -1\\
-1 &  6 & -1 & -1 & -1\\
-1 & -1 &  6 & -1 & -1\\
-1 & -1 & -1 &  6 & -1\\
-1 & -1 & -1 & -1 &  6
\end{array}\right)
\left(\begin{array}{c}
\mathbf{r}_{\text{DEN}}\\
\mathbf{r}_{\text{LAL}}\\
\mathbf{r}_{\text{SAS}}\\
\mathbf{r}_{\text{CHI}}\\
\mathbf{r}_{\text{NYK}}
\end{array}\right)
=
\left(\begin{array}{c}
0\\
0\\
2\\
1\\
2
\end{array}\right)
\end{equation*}
La Tabla \ref{tbl:colley_con_empates} muestra los cálculos tras resolver el sistema.\\

\begin{table}[h]
\centering
\caption{Resultados del Ejemplo \ref{ej:colley} con empates}
\label{tbl:colley_con_empates}
\begin{tabular}{@{}ccc@{}}
\cmidrule(l){2-3}
    & $\mathbf{r}$ & Ranking \\ \midrule
DEN & 0.3571       & 4       \\
LAL & 0.3571       & 4       \\
SAS & 0.6429       & 1       \\
CHI & 0.5          & 3       \\
NYK & 0.6429       & 1       \\ \bottomrule
\end{tabular}
\end{table}

Notar que en este caso se producen empates. Para romperlos se pueden seguir varias estrategias: una de ellas es hacer uso de los datos pasados, es decir, si los equipos $i$ y $j$ están empatados y se enfrentaron entre ellos, el equipo ganador estará por encima del equipo perdedor. Otra opción es aplicar una un ``rating de desempate'' que consiste en tener otro rating, y desempatar a partir de éste, es decir, si dos equipos están empatados aparecerá primero en el ranking el primero que aparezca en el rating de desempate. La elección de este rating no tiene que ser arbitraria, sino que puede ser elegida de acuerdo a algún criterio específico.\\

En nuestro caso, aplicamos el rating de desempate, el de los puntos de diferencia (Tabla \ref{tbl:massey}). Al aplicar este criterio para desempatar, NYK se coloca por encima de SAS por tener mayor diferencia de puntos (24 contra 21). De la misma forma, se rompe el empate entre LAL y DEN. La Tabla \ref{tbl:colley_resultados_sin_empates} muestra el resultado tras romper los empates.

\begin{table}[h]
\centering
\caption{Resultados del Ejemplo \ref{ej:colley} tras romper los empates}
\label{tbl:colley_resultados_sin_empates}
\begin{tabular}{@{}cccc@{}}
\cmidrule(l){2-4}
\multicolumn{1}{l}{} & $\mathbf{r}$ & Ranking & \begin{tabular}[c]{@{}c@{}}Diferencia \\ de puntos\end{tabular} \\ \midrule
DEN                  & 0.3571       & 5       & -38                                                             \\
LAL                  & 0.3571       & 4       & -18                                                             \\
SAS                  & 0.6429       & 2       & 21                                                              \\
CHI                  & 0.5          & 3       & 11                                                              \\
NYK                  & 0.6429       & 1       & 24                                                              \\ \bottomrule
\end{tabular}
\end{table}

\end{ejemplo}



\paragraph*{Resumen y algoritmo de cómputo}

Las variables y su descripción se pueden encontrar en la siguiente tabla:

\begin{longtable}{c c p{5cm} p{6cm}}
\caption{Resumen del método de Colley}\\
%\renewcommand{\arraystretch}{1.5}
\toprule
Variable & Tipo & Descripción & Elemento i-ésimo\\
\hline
\endfirsthead

\multicolumn{4}{c}%
{{\cftfigfont \tablename\ \thetable{} -- Continúa de la página anterior}} \\
\toprule
Variable & Tipo & Descripción & Elemento i-ésimo\\
\hline
\endhead

$\mathbf{C}$ & $M_{n \times n}$ & Matriz de Colley. Matriz simétrica y definida positiva & $ \mathbf{C}_{ij} = \begin{cases}
2 + t_i & \text{si } i = j\\
-n_{ij} & \text{si } i \neq j
\end{cases}$\\
\hline
$t_i$ & $\N$ & Número total de partidos jugados por el equipo $i$ & ---\\
\hline 
$n_{ij}$ & $\N$ & Número de veces que $i$ y $j$ se han enfrentado & ---\\
\hline
$\mathbf{b}$ & $M_{n \times 1}$ & Vector del lado derecho del sistema & $b_i = 1+ \dfrac{1}{2}(w_i - l_i)$ \\
\hline 
$w_i$ & $\N$ & Número de victorias del equipo $i$ & --- \\
\hline
$l_i$ & $\N$ & Número de derrotas del equipo $i$ & ---\\
\hline 
$\mathbf{r}$ & $M_{n\times 1}$ & Vector de ratings producido por el método de Colley & ---\\
\hline
$n$ & $\N$ & Número de equipos en la liga. Orden de $\mathbf{C}$ & ---\\
\bottomrule
\end{longtable}

El algoritmo para calcular este método es:

\begin{enumerate}
\item Resolver el sistema $\mathbf{C r} = \mathbf{b}$.
\end{enumerate}

\subsection{Método de Markov}

El método de Markov hace uso de las cadenas de Markov, que inventó en 1906, para describir procesos estocásticos. Aquí las aplicaremos para crear rankings deportivos.\\

Este método se basa en utilizar varios parámetros stadísticos como victorias y derrotas, diferencias de puntos entre dos equipos, etc para crear un rating. El objetivo es crear una matriz estocastica de todos los parámetros y calcular el punto fijo de la cadena de Markov, que será nuestro rating $\mathbf{r}$. Para cada uno de los parámetros, se crea una matriz $\mathbf{V}_i$. Necesitamos una matriz estocástica $\mathbf{S}_i$. Normalmente, esta matriz $\mathbf{V}_i$ no será estocástica, por lo que debemos normalizar cada fila, diviendo entre la suma de cada fila. Es posible que haciendo esto no se consiga una matriz estocástica, puesto que puede haber filas completamente llenas de ceros. Para tratar con ésto, se pueden seguir varias estrategias: una forma sencilla es sustituir la fila de ceros por una columna de unos y normalizar la fila como hemos comentado anteriormente. Esta forma resuelve el problema y crea una matriz estocástica, pero hay otras formas de resolver el problema que tienen más sentido en rankings deportivos.  Otra forma es sustituir el i-ésimo cero por un uno en la fila. Esto crea un nuevo problema, y es que la cadena no es necesarimente irreducible (lo que asegura la existencia y unicidad del punto fijo). Para conseguir esto creamos una matriz $\overline{\mathbf{S}}$, definida de la siguiente manera:

\begin{equation}
\overline{\mathbf{S}} = \beta \mathbf{S} + \dfrac{(1 - \beta)}{n} \mathbf{E}
\end{equation}

donde $\mathbf{E}$ es una matriz de unos, $n$ es el número de equipos y $\beta \in [0, 1]$. De esta manera $\overline{\mathbf{S}}$, el punto fijo existe y es único. El vector rating $\mathbf{r}$ depende de la elección del parámetro $\beta$. Generalmente, cuanto mayor es $\beta$, el modelo se aproxima más a los datos originales.  
De esta forma se consigue que cada fila sea un vector de probabilidad. Para obtener la matriz estocástica que agrupe todos las estadísticas $\mathbf{S}_i$, creamos una nueva matriz estocástica $\mathbf{S}$ de la siguiente manera: 
\begin{equation}
\mathbf{S} = \sum_{i=1}^{k} \alpha_i \mathbf{S}_i
\end{equation}

donde $a_i \geq 0$ y $\sum_{i=1}^{k} \alpha_i = 1$. 

\begin{ejemplo}\label{ej:markov}
Volvemos a considerar los datos de la Tabla \ref{tbl:massey} y \ref{tbl:colley}. Sólo consideraremos dos estadísticas: la de puntos y la de victorias.\\

Formamos las matrices $\mathbf{V}_p$ y $\mathbf{V}_v$ que representan las estadísticas de puntos y de victorias, respectivamente.

\[ \mathbf{V}_p = \left(\begin{array}{rrrrr}
0   & 115 & 108 & 117 & 117\\
137 & 0   & 100 & 102 & 110\\
103 & 113 & 0   & 96  & 89 \\
89  & 100 & 104 & 0   & 100\\
90  & 103 & 100 & 89  & 0
\end{array}\right) \]

\[ \mathbf{V}_v = \left(\begin{array}{rrrrr}
0 & 0 & 1 & 1 & 1\\
1 & 0 & 0 & 1 & 1\\
0 & 1 & 0 & 0 & 0\\
0 & 0 & 1 & 0 & 1\\
0 & 0 & 1 & 0 & 0
\end{array}\right) \]

Creamos las matrices estocásticas $\mathbf{S}_p$ y $\mathbf{S}_v$, dividiendo cada fila entre la suma de la fila:

\[ \mathbf{S}_p = \left(\begin{array}{rrrrr}
0      & 0.2516 & 0.2363 & 0.2560 & 0.2560 \\
0.3051 & 0      & 0.2227 & 0.2272 & 0.2450 \\
0.2569 & 0.2818 & 0      & 0.2394 & 0.2219 \\
0.2265 & 0.2545 & 0.2646 & 0      & 0.2545 \\
0.2356 & 0.2696 & 0.2618 & 0.2330 & 0
\end{array}\right) \]

\[ \mathbf{S}_v = \left(\begin{array}{rrrrr}
0     & 0   & 1/3 & 1/3 & 1/3\\
1/3   & 0   & 0   & 1/3 & 1/3\\
0     & 1   & 0   & 0   & 0  \\
0     & 0   & 1/2 & 0   & 1/2\\
0     & 0   & 1   & 0   & 0
\end{array}\right) \]

Creamos la matriz $\mathbf{S} = \alpha_1 \mathbf{S}_p + \alpha_2 \mathbf{S}_v$. Elegimos $\alpha_1 = 0.7$ y $\alpha_2 = 0.3$. Normalmente estos valores se eligen por un experto que determina qué estadísticas son más transcendentes en el juego.\\

La matriz $\mathbf{S}$ queda así:

\[ \mathbf{S} = \left(\begin{array}{rrrrr}
0      & 0.0915 & 0.3104 & 0.3013 & 0.3040 \\
0.3088 & 0      & 0.0845 & 0.3097 & 0.3142 \\
0.0709 & 0.7668 & 0      & 0.0794 & 0.0785 \\
0.0768 & 0.0682 & 0.4218 & 0      & 0.4199 \\
0.0768 & 0.0735 & 0.7666 & 0.0763 & 0

\end{array}\right) \]

Necesitamos saber si $\mathbf{S}$ es irreducible. Para ello, aplicamos el siguiente resultado.\\

\begin{prop}
Sea $\mathbf{S}$ la matriz de transición de una cadena de Markov, cuyo autovalor $\lambda = 1$ corresponde con el autovector $\mathbf{r}$. Entonces, la cadena de Markov es irreducible si todos los elementos de $\mathbf{r}$ son no nulos.
\end{prop}


Tenemos que calcular los autovalores y autovectores de $\mathbf{S}$.\\

Los autovalores de $\mathbf{S}$ son $\lambda = 1, -0.2454 \pm 0.536i, -0.2549 \pm 0.0833i$.\\
El autovalor asociado a $\lambda = 1$ es $\mathbf{r} = (-0.2649, -0.5337, -0.5946, -0.3250, -0.4311)^T$. Como todas las componentes de $\mathbf{r}$ son no nulas, entonces $\mathbf{S}$ es irreducible. Sólo nos queda normalizar el vector $\mathbf{r}$. Los resultados se muestran en la Tabla \ref{tbl:markov_resultados}. 

\begin{table}[h]
\centering
\caption{Resultados del Ejemplo \ref{ej:markov}}
\label{tbl:markov_resultados}
\begin{tabular}{@{}ccc@{}}
\cmidrule(l){2-3}
    & $\mathbf{r}$ & Ranking \\ \midrule
DEN & 0.1232       & 5       \\
LAL & 0.2483       & 2       \\
SAS & 0.2766       & 1       \\
CHI & 0.1512       & 4       \\
NYK & 0.2006       & 3       \\ \bottomrule
\end{tabular}
\end{table}

\end{ejemplo}

\paragraph*{Resumen y algoritmo de cómputo}

Las variables y su descripción se pueden encontrar en la siguiente tabla:

\begin{longtable}{c c p{5cm} p{6cm}}
\caption{Resumen del método de Markov}\\
%\renewcommand{\arraystretch}{1.5}
\toprule
Variable & Tipo & Descripción & Elemento i-ésimo\\
\hline
\endfirsthead

\multicolumn{4}{c}%
{{\cftfigfont \tablename\ \thetable{} -- Continúa de la página anterior}} \\
\toprule
Variable & Tipo & Descripción & Elemento i-ésimo\\
\hline
\endhead

$k$ & $\N$ & Número de estadísticas para incorporar al método de Markov & ---\\
\hline
$\mathbf{V}_k$ & $\R^{n \times n}$ & Matriz k-ésima con los resultados de la estadística $k$  & $[\mathbf{V}_k]_{ij}$ estadística k-ésima que se le asigna al equipo $i$ contra el equipo $j$. \\
\hline 
$\mathbf{S}_k$ & $\R^{n \times n}$ & Matrices estocásticas construidas a partir de $\mathbf{V}_k$ & ---\\
\hline
$\alpha_i$ & $\R$ & Peso asociado con la estadística $i$; $a_i \geq 0$ y $\sum_{i=1}^{k} \alpha_i = 1$  & --- \\
\hline 
$\overline{\mathbf{S}}$ & $\R^{n \times n}$ & Matriz estocástica que se asegura ser irreducible; $\overline{\mathbf{S}} = \beta \mathbf{S} + \frac{(1 - \beta)}{n} \mathbf{E}$, $\beta \in [0,1]$ & --- \\
\hline
$\mathbf{r}$ & $\R^{n \times 1}$ & Vector rating del método calculado a partir del punto fijo de la cadena. Vector de ratings producido por el método de Markov & ---\\
\hline 
$n$ & $\N$ & Número de equipos en la liga. Orden de $\overline{\mathbf{S}}$ & ---\\
\bottomrule
\end{longtable}

El algoritmo para calcular este método es:

\begin{enumerate}
\item Formar $\mathbf{S}$ usando las matrices $\mathbf{V}_i$ para cada una de las $k$ estadísticas.

\[ \mathbf{S} = \sum_{i=1}^{k} \alpha_i \mathbf{S}_i \]

donde $a_i \geq 0$ y $\sum_{i=1}^{k} \alpha_i = 1$.

\item Calcular $\mathbf{r}$, el punto fijo de la matriz de transición $\mathbf{S}$. Si $\mathbf{S}$ es reducible, usar la matriz irreducible $\overline{\mathbf{S}}$

\[\overline{\mathbf{S}} = \beta \mathbf{S} + \dfrac{(1 - \beta)}{n} \mathbf{E}\]
\end{enumerate}

\subsection{Relación entre los métodos}

\subsubsection{Relación entre el método de Massey y de Colley}

Estos dos métodos esán relacionados por la fórmula $\mathbf{C} = 2\mathbf{I} + \mathbf{M}$. El método de Massey $\mathbf{M r} = \mathbf{p}$ puede ser convertido puede ser Colleyzado como

\[ (2\mathbf{I} + \mathbf{M})\mathbf{r} = \mathbf{p} \]

Este nuevo método tiene en el lado derecho del sistema el vector $\mathbf{p}$ en vez de $\mathbf{b}$, que sólo usa información de victorias y derrotas. Además añadir $2\mathbf{I}$ al sistema hace que el sistema sea no singular, por lo que no hace falta eliminar una ecuación del sistema.

\begin{ejemplo}\label{ej:massey_colleyizado}
Si consideramos los Ejemplos \ref{ej:massey} y \ref{ej:colley}, y aplicamos este método el sistema resultante queda de la siguiente manera:

\begin{equation*}
\left(\begin{array}{r r r r r}
 6 & -1 & -1 & -1 & -1\\
-1 &  6 & -1 & -1 & -1\\
-1 & -1 &  6 & -1 & -1\\
-1 & -1 & -1 &  6 & -1\\
-1 & -1 & -1 & -1 &  6
\end{array}\right)
\left(\begin{array}{c}
\mathbf{r}_{\text{DEN}}\\
\mathbf{r}_{\text{LAL}}\\
\mathbf{r}_{\text{SAS}}\\
\mathbf{r}_{\text{CHI}}\\
\mathbf{r}_{\text{NYK}}
\end{array}\right)
=
\left(\begin{array}{c}
-38\\
-18\\
21\\
11\\
24
\end{array}\right)
\end{equation*}

Los resultados se muestran en la Tabla \ref{tbl:massey_colleyizado}

\begin{table}[h]
\centering
\caption{Resultados del Ejemplo \ref{ej:massey_colleyizado}}
\label{tbl:massey_colleyizado}
\begin{tabular}{@{}ccc@{}}
\cmidrule(l){2-3}
    & $\mathbf{r}$ & Ranking \\ \midrule
DEN & -5.4286      & 5       \\
LAL & -2.5714      & 4       \\
SAS &  3.0000      & 2       \\
CHI &  1.5714      & 3       \\
NYK &  3.4286      & 1       \\ \bottomrule
\end{tabular}
\end{table}

\end{ejemplo}



De la misma forma, el método de Colley $\mathbf{C r} = \mathbf{b}$ puede ser Masseyizado con la relación anterior. De esta forma, se trata de resolver el sistema

\[ \mathbf{M r} = \mathbf{b} \]

\begin{ejemplo}\label{ej:colley_masseyizado}
Si consideramos los Ejemplos \ref{ej:massey} y \ref{ej:colley}, y aplicamos este método el sistema resultante queda de la siguiente manera:

\begin{equation*}
\left(\begin{array}{r r r r r}
 4 & -1 & -1 & -1 & -1\\
-1 &  4 & -1 & -1 & -1\\
-1 & -1 &  4 & -1 & -1\\
-1 & -1 & -1 &  4 & -1\\
 1 &  1 &  1 &  1 &  1
\end{array}\right)
\left(\begin{array}{c}
\mathbf{r}_{\text{DEN}}\\
\mathbf{r}_{\text{LAL}}\\
\mathbf{r}_{\text{SAS}}\\
\mathbf{r}_{\text{CHI}}\\
\mathbf{r}_{\text{NYK}}
\end{array}\right)
=
\left(\begin{array}{c}
0\\
0\\
2\\
1\\
2
\end{array}\right)
\end{equation*}

Los resultados se muestran en la Tabla \ref{tbl:colley_masseyizado}\\

\begin{table}[h]
\centering
\caption{Resultados del Ejemplo \ref{ej:colley_masseyizado} con empates}
\label{tbl:colley_masseyizado}
\begin{tabular}{@{}ccc@{}}
\cmidrule(l){2-3}
    & $\mathbf{r}$ & Ranking \\ \midrule
DEN &  0.4      & 3       \\
LAL &  0.4      & 3       \\
SAS &  0.8      & 2       \\
CHI &  0.6      & 1       \\
NYK & -0.2      & 5       \\ \bottomrule
\end{tabular}
\end{table}

Se produce un empate entre DEN y LAL. Para desempatar, empleamos de nuevo los puntos de diferencia entre estos dos equipos. Puesto que LAL tiene una menor diferencia de puntos frente a DEN (-18 contra -38), por lo que se rompe el empate y LAL se posiciona en la cuarta posición del ranking.\\

Los resultados tras romper el empate se muestra en la Tabla \ref{tbl:colley_masseyizado_sin_empates}.


\begin{table}[h]
\centering
\caption{Resultados del Ejemplo \ref{ej:colley_masseyizado} sin empates}
\label{tbl:colley_masseyizado_sin_empates}
\begin{tabular}{@{}ccc@{}}
\cmidrule(l){2-3}
    & $\mathbf{r}$ & Ranking \\ \midrule
DEN &  0.4      & 4       \\
LAL &  0.4      & 3       \\
SAS &  0.8      & 2       \\
CHI &  0.6      & 1       \\
NYK & -0.2      & 5       \\ \bottomrule
\end{tabular}
\end{table}
\end{ejemplo}

\subsubsection{Relación entre el método de Markov y el de Massey}

Aunque a primera vista ambos métodos parecen no tener poco o nada en común. Como apuntábamos anteriormente, el método de Markov permite tratar distintas estadísticas entre las que se encuentra la diferencia de puntos, en lo que está basado el método de Massey. Recordemos que que la ecuación fundamental del método de Massey es

\[ r_i - r_j = y_k \]

que indica que el equipo $i$ gana al equipo $j$ por $y_k$ puntos de diferencia. Si representamos la información del método de Massey mediante un grafo ponderado donde los pesos son la diferencia de puntos y comparamos con el grafo que proviene de la matriz $\mathbf{V}$ de diferencia de puntos, veremos que son el mismo grafo, pero con distinta orientación. En el grafo de Massey, la orientación implica dominancia, mientras que en el grafo de Markov implica debilidad.

\begin{ejemplo}
Si consideramos la diferencia de puntos de la Tabla \ref{tbl:massey}, y dibujamos los grafos de Massey y de Markov, vemos que son el mismo grafo, pero con orientación opuesta.

\begin{figure}[htb]
\centering
\subfigure[Ejemplo de grafo de Markov]{\ejemplografomarkov}
\subfigure[Ejemplo de grafo de Massey]{\ejemplografomassey}
\caption[Ejemplo de grafo de Markov y de Massey]{Ejemplo de grafo de Markov y de Massey. Se puede observar como los grafos son iguales, pero con orientación opuesta}
\label{fig:grafo_massey_markov}
\end{figure}
\end{ejemplo}


