\chapter{Conceptos básicos}

En este capítulo veremos dos conceptos centrales de esta memoria: ranking y rating, y veremos varios métodos para crear rankings.\\

Para entender estos conceptos intuitivamente veamos un ejemplo:

\begin{ejemplo}
Si consideramos los siguientes jugadores de la NBA: Kareem Abdul-Jabbar, Karl Malone, Michael Jordan, Kobe Bryant y Wilt Chamberlain, y consideramos los puntos y rebotes\footnote{Datos extraídos de \url{http://stats.nba.com/leaders/alltime}} anotados por cada uno de estos jugadores a lo largo de su carrera en temporada regular, obtenemos la siguiente tabla:

\begin{table}[h]
\centering
\caption[Puntos y rebotes de los máximos anotadores de la NBA]{Puntos y rebotes de los máximos anotadores de la NBA en temporada regular}
\label{tbl:puntos_rebotes}
\begin{tabular}{@{}lcc@{}}
\cmidrule(l){2-3}
\multicolumn{1}{c}{}      & \multicolumn{2}{c}{En temporada regular} \\ \cmidrule(l){2-3} 
\multicolumn{1}{c}{}      & Puntos             & Rebotes             \\ \midrule
Kareem Adbul-Jabbar (KAJ) & 38387              & 17440               \\ \midrule
Karl Malone (KM)          & 36928              & 14968               \\ \midrule
Michael Jordan (MJ)       & 32292              & 6662                \\ \midrule
Kobe Bryant (KB)          & 32030              & 6672                \\ \midrule
Wilt Chamberlaint (WC)    & 31419              & 23924               \\ \bottomrule
\end{tabular}
\end{table}

Estas dos ordenaciones de los jugadores es lo que recibe el nombre de rating. De cada uno de estos ratings, se puede obtener un ranking que son las posiciones de cada jugador en cada rating. En el ejemplo,

\[
\begin{array}{ccc}
\text{Posición} & \text{Puntos} & \text{Rebotes}\\ 
\begin{array}{c}
\text{1}\\
\text{2}\\
\text{3}\\
\text{4}\\
\text{5}\\
\end{array} & \left(\begin{array}{c}
\text{KAJ}\\
\text{KM}\\
\text{MJ}\\
\text{KB}\\
\text{WC}\\
\end{array} \right) & \left(\begin{array}{c}
\text{WC}\\
\text{KAJ}\\
\text{KM}\\
\text{KB}\\
\text{MJ}\\
\end{array} \right)
\end{array}
\]

En general, los ratings producen distintos rankings. En el ejemplo, se puede ver como en el ranking de rebotes Wilt Chamberlain se encuentra en 1ª posición, mientras que en el de rebotes se encuentra en 5ª posición. Otros rankings ficticios para el ejemplo podrían ser

\[
\begin{array}{ccc}
\begin{array}{c}
\text{1}\\
\text{2}\\
\text{3}\\
\text{4}\\
\text{5}\\
\end{array} & \left(\begin{array}{c}
\text{MJ}\\
\text{KB}\\
\text{KM}\\
\text{KAJ}\\
\text{WC}\\
\end{array} \right) & \left(\begin{array}{c}
\text{KB}\\
\text{MJ}\\
\text{KM}\\
\text{WC}\\
\text{KAJ}\\
\end{array} \right)
\end{array}
\]

\end{ejemplo}

De forma intuitiva, podríamos decir que un rating es un criterio para ordenar una serie de elementos, y un ranking son todas los posibles ordenamientos de un un conjunto de elementos. De forma rigurosa, las definiciones anteriores quedan así:

\begin{defi} \label{def:ranking}
Dado un conjunto $\mathcal{N} = \{1,\dots,n\}$ que llamamos nodos, definimos el ranking $c$ como cualquier biyección $c : \mathcal{N} \to \mathcal{N}$.
\end{defi}

De acuerdo a esta definición, en el ejemplo, $\mathcal{N} = \{1,2,3,4,5\}$, donde $\text{KAJ}\equiv 1$, $\text{KM}\equiv 2$, $\text{MJ}\equiv 3$, $\text{KB}\equiv 4$, $\text{WC}\equiv 5$. Así, si consideramos el ranking de rebotes, entonces

\[ \begin{array}{rlll}
c: & \mathcal{N} & \to & \mathcal{N}\\
& 1 & \mapsto & 5\\
& 2 & \mapsto & 1\\
& 3 & \mapsto & 2\\
& 4 & \mapsto & 4\\
& 5 & \mapsto & 3\\
\end{array} \] 

que es claramente una biyección, por lo que $c$ es un ranking de acuerdo a la definición \ref{def:ranking}. De la misma forma se obtienen que los demás rankings también cumplen la definición.\\

Además, escribiremos $i \prec_c j$ cuando el nodo $i \in \mathcal{N}$ aparezca antes que el nodo $j \in \mathcal{N}$ en el ranking $c$.

En el ejemplo, el nodo $5 \prec_c 3$ ya que el nodo $5$, WC aparece más alto que el nodo $3$, MJ.

\begin{defi}
Dado un conjunto $\mathcal{N} = \{1,\dots, n\}$ de nodos, decimos que es un rating si a cada $i \in \mathcal{N}$ se le asigna un valor real. 
\end{defi}

Notar que un rating cuando se ordena (ascendente o descendentemente), crea un ranking.\\

En el ejemplo anterior, la cantidad de puntos y rebotes a lo largo de la carrera en temporada regular en la NBA son ratings, y dados éstos obtenemos un ranking. En estos dos casos, hemos ordenado descendentemente el rating, pero también podría ordenarse de forma ascendente como en el caso de número de pérdidas de balón por partido a lo largo de la temporada regular. 

\section{Métodos para obtener ratings (y rankings)}
\todo[backgroundcolor=red, inline]{Añadir pequeña introducción}
\subsection{Método de Massey}
El método de Massey fue creado por Kenneth Massey en 1997 con la intención de obtener rankings de los equipos universitarios de EEUU. Este método usa la teoría de mínimos cuadrados. La idea fundamental de este método se basa en la siguiente ecuación idealizada:

\begin{equation}
r_i - r_j = y_k
\end{equation} 

donde $y_k$ es el margen de victoria para el partido $k$, y $r_i$ y $r_j$ son los ratings de los equipos $i$ y $j$, respectivamente. En otras palabras, la diferencia de los ratings $r_i$ y $r_j$ de dos equipos predice idealmente el margen de victoria en un enfrentamiento entre estos dos equipos. \\

El objetivo es asociar un rating a cada equipo en una liga con $n$ equipos, donde $m$ es el total de partidos disputados hasta la fecha. No conocemos los ratings $r_i$, pero sí conocemos quién jugó con quién y el margen de victoria. De esta manera, podemos formar para cada partido $k$ un sistema lineal con $m$ ecuaciones y $n$ incógnitas:

\[\mathbf{X r } = \mathbf{y}\]

Los coeficientes de cada fila de la matriz $\mathbf{X}$ son casi todos nulos, excepto en la posición $i$ que tiene un $1$, y en la posición $j$ con un $-1$, para indicar que el equipo $i$ gana al equipo $j$ en un partido. Normalmente, $m \gg n$ que hace que el sistema sea incompatible y no tenga solución. Se puede obtener una solución aplicando las ecuaciones normales de los mínimos cuadrados, quedando el sistema $\mathbf{X^T X r} = \mathbf{X^T y}$. \\

Massey descubrió que debido a la estructura de $\mathbf{X}$ era ventajoso la utilización de la matriz $\mathbf{M} = \mathbf{X^T X}$. De hecho, esta matriz no necesita ser calculada. Se puede obtener fácilmente usando el hecho de que los elementos de la diagonal $\mathbf{M}_{ii}$ es el total de partidos jugados por el $i$ contra el equipo $j$, y los elementos $\mathbf{M}_{ij}$ con $(i \neq j)$ es la negación del número de partidos jugados por el equipo $i$ contra el equipo $j$. El elemento i-ésimo de parte derecha de la ecuación se puede calcular es la suma de las diferencias de puntos para cada partidos disputado por el equipo $i$, y así definimos $\mathbf{p} = \mathbf{X^T y}$.\\
Usando estas notaciones el sistema se transforma en el siguiente sistema:

\[ \mathbf{M r} = \mathbf{p} \]

\paragraph*{Propiedades de la matriz $\mathbf{M}$}

\begin{enumerate}
\item La matriz $\mathbf{M}$ es una matriz cuadrada de orden $n$.
\item $\mathbf{M}$ es una matriz diagonalmente dominante.
\item Sus filas suman $0$. Como consecuencia, sus columnas son linealmente dependientes. Esto hace que el sistema  $\mathbf{M r} = \mathbf{p}$ no tenga solución única cuando el $\rang(\mathbf{M}) < n$. El problema se puede solventar añadiendo una fila entera de $1$ y en la posición correspondiente de $\mathbf{p}$ añadir un $0$. Con la nueva fila, el sistema queda 
\begin{equation}
\overline{\mathbf{M}} \mathbf{r} = \overline{\mathbf{p}} \label{eq:massey_general}
\end{equation}
\end{enumerate}

\begin{ejemplo}\label{ej:massey}
Si consideramos una liga formada por los siguientes equipos de la NBA: Denver Nuggets (DEN), Los Ángeles Lakers (LAL), San Antonio Spurs (SAS), Chicago Bulls (CHI) y New York Knicks (NYK), y los partidos disputados entre estos equipos (Tabla \ref*{tbl:massey})

\begin{table}[h]
\centering
\caption{Partidos disputados por los equipos del Ejemplo \ref{ej:massey}}
\label{tbl:massey}
\begin{tabular}{@{}c|ccccc|c@{}}
\cmidrule(l){2-7}
    & DEN     & LAL     & SAS     & CHI     & NYK     & \begin{tabular}[c]{@{}c@{}}Diferencia\\ de puntos\end{tabular} \\ \midrule
DEN & ---     & 137-115 & 103-108 & 89-117  & 90-117  & \textcolor{red}{-82}                                                            \\ \midrule
LAL & 115-137 & ---     & 113-100 & 100-102 & 103-110 & \textcolor{red}{-4}                                                             \\ \midrule
SAS & 108-103 & 100-113 & ---     & 104-96  & 110-89  & \textcolor{green}{76}                                                           \\ \midrule
CHI & 117-89  & 102-100 & 96-104  & ---     & 89-100  & \textcolor{red}{-5}                                                            \\ \midrule
NYK & 117-90  & 110-103 & 89-110  & 100-89  & ---     & \textcolor{red}{-48}                                                            \\ \bottomrule
\end{tabular}
\end{table}

Necesitamos la matriz $\mathbf{\overline{M}}$ de Massey y el vector $\mathbf{p}$ de diferencia de puntos para formar el sistema $\mathbf{\overline{M} r} = \mathbf{p}$.\\

Formamos la matriz $\mathbf{\overline{M}}$, poniendo en la diagonal el número de partidos jugados por cada equipo, en este caso $4$. En todos los demás elementos ponemos $-1$, excepto en la última fila que está formada por $1$ para conseguir que este sistema tenga una única solución. El vector $\mathbf{p}$ lo obtenemos directamente de la Tabla \ref{tbl:massey}, pero cambiando el último término por un $0$.\\
Así el sistema $\mathbf{\overline{M} r} = \mathbf{p}$ queda

\begin{equation*}
\left(\begin{array}{r r r r r}
4  & -1 & -1 & -1 & -1\\
-1 &  4 & -1 & -1 & -1\\
-1 & -1 &  4 & -1 & -1\\
-1 & -1 & -1 &  4 & -1\\
 1 &  1 &  1 &  1 &  1 
\end{array}\right)
\left(\begin{array}{c}
\mathbf{r}_{\text{DEN}}\\
\mathbf{r}_{\text{LAL}}\\
\mathbf{r}_{\text{SAS}}\\
\mathbf{r}_{\text{CHI}}\\
\mathbf{r}_{\text{NYK}}
\end{array}\right)
=
\left(\begin{array}{c}
-82\\
-4\\
76\\
-5\\
0
\end{array}\right)
\end{equation*}

Resolviendo este sistema obtenemos los siguientes resultados (Tabla \ref{tbl:massey_resultados})

\begin{table}[h]
\centering
\caption{Resultados del Ejemplo \ref{ej:massey}}
\label{tbl:massey_resultados}
\begin{tabular}{@{}ccc@{}}
\cmidrule(l){2-3}
    & $\mathbf{r}$ & Ranking \\ \cmidrule(l){2-3} 
DEN & -16.4          & 5       \\ \midrule
LAL & -0.8       & 4       \\ \midrule
SAS & 15.2         & 1       \\ \midrule
CHI & -1        & 3       \\ \midrule
NYK & 3         & 2       \\ \bottomrule
\end{tabular}
\end{table}
\end{ejemplo}
\subsubsection{Método de Massey avanzado}

El método de Massey avanzado crea dos nuevos vectores respecto al método anterior: el rating ofensivo $\mathbf{o}$ y el rating defensivo $\mathbf{d}$, con $\mathbf{r} = \mathbf{o} + \mathbf{d}$. Este método descompone $\mathbf{p}$ en otros dos vectores: $ \mathbf{p} = \mathbf{f} - \mathbf{a}$, donde $\mathbf{f}$ es el número total de puntos marcados por cada equipo, y $\mathbf{a}$ es el número total de puntos marcados contra cada equipo durante la temporada. También se descompone la matriz $\mathbf{M}$ como $\mathbf{M} = \mathbf{T} - \mathbf{P}$, donde $\mathbf{T}$ es una matriz diagonal que contiene el número total de partidos disputados por cada equipo, y $\mathbf{P}$ una matriz sin elementos en la diagonal que contiene el número de parejas de partidos entre los equipos a lo largo de la temporada. Haciendo las sustituciones al sistema $\mathbf{M r } = \mathbf{p}$, el sistema se convierte en

\begin{equation}
\mathbf{T o} - \mathbf{P o} + \mathbf{T d} - \mathbf{P d} = \mathbf{f} - \mathbf{a}
\end{equation}

que puede ser descompuesta en dos ecuaciones

\begin{eqnarray}
\mathbf{T o} - \mathbf{P d} = \mathbf{f}\\ \label{eq:massey_f}
\mathbf{P o} - \mathbf{T d} = \mathbf{a} \label{eq:massey}
\end{eqnarray} 

Sabiendo que $\mathbf{r} = \mathbf{o} + \mathbf{d}$, despejando $\mathbf{o}$ y sustituyendo en la ecuación \ref{eq:massey_f} obtenemos

\begin{equation}
(\mathbf{T} + \mathbf{P})\mathbf{d} = \mathbf{T r} - \mathbf{f} \label{eq:massey_d}
\end{equation}

Esta última ecuación nos permite calcular el vector $\mathbf{d}$ resolviendo el sistema. Notar que $\mathbf{r}$ ya ha sido calculado de la ecuación \ref{eq:massey_general}.

\todo[backgroundcolor=red, inline]{Añadir ejemplo}

\paragraph*{Resumen y algoritmo de cómputo}

La siguiente tabla muestra todos los elementos y su descripción dentro del método que acabamos de describir:

\begin{longtable}{c c p{5cm} p{6cm}}
%{>{\centering\arraybackslash}p{2cm} >{\centering\arraybackslash}p{1.5cm} >{\centering\arraybackslash}p{5cm} >{\centering\arraybackslash}p{6cm}}
\caption{Resumen del método de Massey}\\
%\renewcommand{\arraystretch}{1.5}
\toprule
Variable & Tipo & Descripción & Elemento i-ésimo\\
\hline
\endfirsthead

$n$ & $\N$ & Número de equipos en la liga. Orden de las matrices $\mathbf{T}$,$\mathbf{T}$ y $\mathbf{P}$. & ---\\
\hline
$m$ & $\N$ & Número de partidos jugados & ---\\
\hline
$\mathbf{X}$ & $M_{m\times n}$\footnote{Matrices de tamaño $m \times n$} & Matriz de partidos por equipo & $\mathbf{X}_{ki} = \begin{cases}
1 & \text{si } i \text{ ganó en el partido } k \\
 -1 & \text{si } i \text{ perdió} \\ 
0 & \text{en otro caso}
\end{cases}$ \\
\hline
$\mathbf{T}$ & $M_{n\times n}$ & Matriz diagonal que contiene el número total de partidos disputados & $\mathbf{T}_{ii} = $ número total de partidos disputados por el equipo $i$ \\
\hline
$\mathbf{P}$ & $M_{n\times n}$ & Matriz sin elementos en la diagonal que  contiene información de los partidos & $\mathbf{P}_{ij} = $ número de partidos entre $i$ y $j$ \\
\hline
$\mathbf{M}$ & $M_{n\times n}$ & Matriz simétrica llamada matriz de Massey & $\mathbf{M} = \mathbf{T}-\mathbf{P}$ \\
\hline 
$\overline{\mathbf{M}}$ & $M_{n \times n}$ & Matriz ajustada de Massey que se crea  remplazando una fila de $\mathbf{M}$ por un vector de unos & --- \\
\hline 
$\mathbf{f}$ & $M_{n\times 1}$ & Vector de puntos marcados & $\mathbf{f}_i = $ número de puntos  marcados por $i$ durante la temporada \\
\hline 
$\mathbf{a}$ & $M_{n\times 1}$ & Vector de puntos encajados & $\mathbf{f}_i = $ número de puntos encajados por $i$ durante la temporada \\
\hline 
$\mathbf{p}$ & $M_{n\times 1}$ & Vector de diferencias de puntos & $\mathbf{p}_i = f_i - a_i$ diferencia de puntos acumulados por $i$ durante la temporada \\
\hline 
$\overline{\mathbf{T}}$ & $M_{n\times 1}$ & Vector de diferencias de puntos ajustado creado poniendo un  elemento de $\mathbf{p}$ con $0$ & ---\\
\hline
$\mathbf{r}$ & $M_{n\times 1}$ & Vector de rating producido por 
\ref{eq:massey_general} & ---\\
\hline
$\mathbf{o}$ & $M_{n\times 1}$ & Vector de ranking ofensivo producido
por \ref{eq:massey_general} & ---\\
\hline 
$\mathbf{d}$ & $M_{n\times 1}$ & Vector de ranking defensivo producido por \ref{eq:massey_general} & ---\\

\bottomrule
\end{longtable}

El algoritmo que permite calcular este método es el siguiente:

\begin{enumerate}
\item Resolver el sistema \ref{eq:massey_general}.
\item Resolver el sistema \ref{eq:massey_d}.
\item Calcular el vector $\mathbf{o} = \mathbf{r} - \mathbf{d}$.
\end{enumerate}

\subsection{Método de Colley}

El método de Colley fue creado por el Dr. Wesley Colley en 2001. Su método está basado una idea muy sencilla: el rating del equipo $i$ será el número total de victorias $w_i$ dividido entre el número total de partidos disputados $t_i$, es decir, 

\begin{equation}
r_i = \dfrac{w_i}{t_i}
\end{equation}

La ecuación anterior tiene algunos problemas como que al inicio de la temporada se obtiene un rating de $0/0$, no se tiene en cuenta el adversario al que se enfrenta un equipo, es decir, no se tiene en cuenta si un equipo ``fuerte'' se enfrenta a uno ``débil'' o viceversa. \\
Para solucionar estos problemas, Colley modifica la ecuación de tal forma que se soluciones los problemas anteriores. La ecuación queda de la siguiente manera:

\begin{equation}
r_i = \dfrac{1 + w_i}{2 + t_i} \label{eq:colley}
\end{equation}

De esta forma, al inicio de la temporada el rating del equipo $i$ es $r_i = 1/2$, que evita el $0/0$ de la primera ecuación. También tiene en cuenta la fuerza de los otros equipos, es decir, si un equipo se enfrenta a un equipo ``fuerte'' obtendrá mayor recompensa que otro que se haya enfrentado a un equipo ``débil''. Esto se consigue suponiendo que lo que gana un equipo lo pierde otro. De esta forma, y teniendo que cuenta que al inicio de la temporada el rating de todos los equipos es $1/2$, se obtiene que

\begin{align}
w_i & = \dfrac{w_i - l_i}{2} + \dfrac{w_i + l_i}{2} \\
&= \dfrac{w_i - l_i}{2} + \dfrac{t_i}{2} \\
&= \dfrac{w_i - l_i}{2} + \sum_{j=1}^{t_i} \dfrac{1}{2}
\end{align}  

donde $l_i$ son los partidos perdidos por el equipo $i$. La suma $\sum_{j=1}^{t_i} 1/2 $ es inicialmente igual a $\sum_{j \in O_i} r_j$ donde $O_i$ es el conjunto de oponentes del equipo $i$. A lo largo de la temporada el valor $\sum_{j=1}^{t_i} 1/2 $ no es igual a $\sum_{j \in O_i}$, pero puede ser aproximada por los rating acumulados de los oponentes de un equipo. Se obtiene que

\begin{equation}
w_i = \dfrac{w_i - l_i}{2} + \sum_{j \in O_i} r_j
\end{equation}  

Suponiendo igualdad y añadiendo la fórmula anterior en \ref{eq:colley} se obtiene

\begin{equation}
r_i = \dfrac{1+ (w_i - l_i)/2 + \sum_{j \in O_i} r_j }{2 + t_i}
\end{equation}

La ecuación anterior puede ser convertida en un sistema lineal $\mathbf{C r} = \mathbf{b}$, donde $\mathbf{r}$ es el vector incógnita de ratings, $\mathbf{b}$ es el vector definido como $b_i = 1 + \dfrac{1}{2}(w_i - l_i)$ y $\mathbf{C}$ es la matriz de Colley definida como

\begin{equation}
\mathbf{C}_{ij} = \begin{cases}
2 + t_i & \text{si } i = j\\
-n_{ij} & \text{si } i \neq j
\end{cases}
\end{equation}

donde $n_{ij}$ es el número de veces que han jugado los equipos $i$ y $j$.

\todo[backgroundcolor=red, inline]{Añadir ejemplo}

\paragraph*{Resumen y algoritmo de cómputo}

Las variables y su descripción se pueden encontrar en la siguiente tabla:

\begin{longtable}{c c p{5cm} p{6cm}}
\caption{Resumen del método de Colley}\\
%\renewcommand{\arraystretch}{1.5}
\toprule
Variable & Tipo & Descripción & Elemento i-ésimo\\
\hline
\endfirsthead

\multicolumn{4}{c}%
{{\cftfigfont \tablename\ \thetable{} -- Continúa de la página anterior}} \\
\toprule
Variable & Tipo & Descripción & Elemento i-ésimo\\
\hline
\endhead

$\mathbf{C}$ & $M_{n \times n}$ & Matriz de Colley. Matriz simétrica y definida positiva & $ \mathbf{C}_{ij} = \begin{cases}
2 + t_i & \text{si } i = j\\
-n_{ij} & \text{si } i \neq j
\end{cases}$\\
\hline
$t_i$ & $\N$ & Número total de partidos jugados por el equipo $i$ & ---\\
\hline 
$n_{ij}$ & $\N$ & Número de veces que $i$ y $j$ se han enfrentado & ---\\
\hline
$\mathbf{b}$ & $M_{n \times 1}$ & Vector del lado derecho del sistema & $b_i = 1+ \dfrac{1}{2}(w_i - l_i)$ \\
\hline 
$w_i$ & $\N$ & Número de victorias del equipo $i$ & --- \\
\hline
$l_i$ & $\N$ & Número de derrotas del equipo $i$ & ---\\
\hline 
$\mathbf{r}$ & $M_{n\times 1}$ & Vector de ratings producido por el método de Colley & ---\\
\hline
$n$ & $\N$ & Número de equipos en la liga. Orden de $\mathbf{C}$ & ---\\
\bottomrule
\end{longtable}

El algoritmo para calcular este método es:

\begin{enumerate}
\item Resolver el sistema $\mathbf{C r} = \mathbf{b}$.
\end{enumerate}

\subsection{Método de Markov}

\todo[backgroundcolor=red, inline]{Añadir información}
